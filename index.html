<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chore Chart — Kid-Friendly</title>
<style>
:root{
  --bg:#0b1220;--card:#0f1830;--accent:#ffb86b;--accent2:#7ce3ff;
  --muted:#9aa6c3;--good:#6ee7a6;--bad:#ff6b6b;
}
*{box-sizing:border-box}
html,body{
  height:100%;margin:0;
  font-family:Inter,system-ui,Arial;
  background:linear-gradient(120deg,#071029 0%, #0b1220 40%);
  color:#fff;
}
#app{height:100vh;display:flex;flex-direction:column;gap:8px;padding:12px}

/* header */
.header{display:flex;align-items:flex-start;gap:12px}
.brand{display:flex;flex-direction:column}
.title{font-size:18px;font-weight:700;letter-spacing:0.6px}
.subtitle{font-size:12px;color:var(--muted)}
.daySelectorWrap{
  margin-top:4px;
  font-size:12px;
  text-align:center;
}
.dayButtons{
  display:flex;
  gap:4px;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:4px;
}
.dayBtn{
  background:#020617;
  color:var(--muted);
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.6);
  padding:2px 8px;
  font-size:11px;
  cursor:pointer;
}
.dayBtn.active{
  background:linear-gradient(180deg,var(--accent2),#51c7ff);
  color:#022c3a;
  border-color:transparent;
}

/* HUGE CLOCK UPGRADE */
.bigClock {
  margin: 20px 0 30px;
  text-align: center;
  padding: 20px;
  background: rgba(255,255,255,0.08);
  border-radius: 28px;
  border: 2px solid rgba(255,255,255,0.15);
}
.bigDay {
  font-size: 44px;
  font-weight: 900;
  color: var(--accent2);
  text-shadow: 0 0 20px rgba(124,227,255,0.5);
}
.bigTime {
  font-size: 80px;
  font-weight: 900;
  color: var(--accent);
  text-shadow: 0 0 30px rgba(255,184,107,0.6);
  letter-spacing: 5px;
  margin-top: -10px;
}
@media (max-width: 700px) {
  .bigDay { font-size: 34px; }
  .bigTime { font-size: 60px; letter-spacing: 3px; }
}

/* FOCUS BUTTONS */
.focusSwitcher {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 25px 0;
  flex-wrap: wrap;
}
.focusKidBtn {
  padding: 20px 40px;
  font-size: 22px;
  font-weight: 900;
  border-radius: 30px;
  border: none;
  cursor: pointer;
  background: rgba(255,255,255,0.1);
  color: var(--muted);
  transition: all 0.3s;
  min-width: 200px;
}
.focusKidBtn.active {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #000;
  transform: scale(1.1);
  box-shadow: 0 15px 40px rgba(255,184,107,0.6);
}
.focusKidBtn:hover:not(.active) {
  transform: translateY(-5px);
  background: rgba(255,255,255,0.2);
}

/* controls */
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{
  background:linear-gradient(180deg,var(--accent),#ff8f3a);
  border:none;padding:8px 12px;border-radius:12px;
  color:#091021;font-weight:700;cursor:pointer;
}
.btn.secondary{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);
  color:var(--muted);
}

/* layout */
.container{display:flex;flex:1;gap:12px;align-items:stretch}
.column{
  flex:1;
  background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
  border-radius:14px;padding:12px;
  display:flex;flex-direction:column;min-width:260px;position:relative;
}
.kidHead{display:flex;align-items:center;gap:8px}
.kidAvatar{
  width:52px;height:52px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent2),#ffd27a);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#072033;
}
.kidName{font-weight:800}
.kidXP{font-size:12px;color:var(--muted)}

/* kid frame: list */
.kidFrame{flex:1;display:flex;flex-direction:column;margin-top:12px;min-height:0}

/* task list */
.taskList{overflow:auto;padding-right:6px;flex:1}
.card{
  border-radius:12px;
  padding:16px 14px;
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:14px;
  cursor:pointer;
  transition:transform .12s ease,box-shadow .12s,background .12s ease;
  min-height:80px;
}
.card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(2,6,23,0.6)}
.cardTodo{
  background:linear-gradient(180deg,rgba(127,29,29,0.7),rgba(15,23,42,0.95));
}
.cardDone{
  background:linear-gradient(180deg,rgba(22,163,74,0.7),rgba(15,23,42,0.95));
}

/* star icon on each row */
.starIcon{
  width:38px;height:38px;
  border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;
  background:radial-gradient(circle at 30% 20%,#ffffff,#e5e7eb);
  color:#111827;
  flex-shrink:0;
}

/* label area */
.cardTitle{flex:1}
.cardTitle strong{font-size:18px;}
.cardMeta{font-size:13px;color:var(--muted)}

/* small edit & move buttons */
.editBtn{
  background:transparent;
  border:none;
  color:var(--muted);
  cursor:pointer;
  font-size:12px;
  padding:2px 4px;
  border-radius:6px;
}
.editBtn:hover{
  background:rgba(148,163,184,0.3);
}
.moveBtn{
  background:transparent;
  border:1px solid rgba(148,163,184,0.5);
  color:var(--muted);
  cursor:pointer;
  font-size:10px;
  padding:2px 4px;
  border-radius:6px;
  margin-left:2px;
}
.moveBtn:hover{
  background:rgba(148,163,184,0.25);
}

/* footer stats */
.footerStats{
  display:flex;
  flex-direction:column;
  gap:4px;
  align-items:flex-start;
  margin-top:8px;
  font-size:12px;
  color:var(--muted);
}
.progressOuter{
  width:100%;
  height:8px;
  border-radius:999px;
  background:rgba(148,163,184,0.3);
  overflow:hidden;
}
.progressInner{
  height:100%;
  border-radius:999px;
  background:linear-gradient(90deg,#4ade80,#22c55e);
  width:0%;
}

.addTaskBtn{
  margin-top:4px;
  padding:4px 8px;
  font-size:11px;
  border-radius:8px;
  background:transparent;
  border:1px dashed rgba(148,163,184,0.7);
  color:var(--muted);
  cursor:pointer;
}

/* focus overlay */
.focusOverlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.96);
  display:none;
  align-items:flex-start;
  justify-content:center;
  padding:32px 12px 16px;
  z-index:300;
}
.focusPanel{
  max-width:640px;
  width:100%;
  background:linear-gradient(180deg,#111827,#020617);
  border-radius:18px;
  padding:16px 16px 18px;
  box-shadow:0 24px 60px rgba(0,0,0,0.85);
}
.focusTitle{
  font-size:32px;
  font-weight:900;
  margin-bottom:8px;
  text-align:center;
}
.focusInstr{
  max-width:100%;
  text-align:left;
  margin-bottom:16px;
  background:rgba(15,23,42,0.95);
  padding:14px;
  border-radius:12px;
  font-size:14px;
}
.focusSteps{list-style:none;padding:0;margin:8px 0}
.focusStep{
  padding:8px 10px;
  background:rgba(15,23,42,0.9);
  margin-bottom:6px;
  border-radius:10px;
  font-size:14px;
}
.tip{font-size:12px;color:var(--muted);margin-top:6px}

/* timer */
.timerShell{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  margin:8px 0;
}
.timerBig{
  font-size:64px;
  font-weight:900;
  text-align:center;
  color:var(--good);
}
.timerBig.overdue{
  color:var(--bad);
}

/* minutes control */
.fieldRow{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
  font-size:14px;
}
.fieldRow label{color:var(--muted);}
.fieldRow input[type="number"]{
  width:90px;
  padding:6px 8px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,0.6);
  background:#020617;
  color:#e5e7eb;
  font-size:14px;
}

/* focus buttons - BIGGER */
.focusButtons{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:6px;
  margin-top:6px;
}
.focusBtn{
  padding:14px 22px;
  border-radius:16px;
  border:none;
  font-size:18px;
  font-weight:700;
  cursor:pointer;
  min-width:130px;
}

/* confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:200}
.sparkle{
  position:absolute;width:10px;height:10px;border-radius:50%;
  background:var(--accent);filter:blur(6px);opacity:.9;
}

/* modal for editing tasks & stats */
#overlays{position:fixed;inset:0;pointer-events:none;z-index:220;}
.modalWrap{
  position:absolute;inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:auto;
}
.modalBox{
  background:#0f1830;
  border-radius:14px;
  padding:12px;
  width:92%;
  max-width:520px;
  box-shadow:0 20px 40px rgba(0,0,0,0.75);
  font-size:13px;
}
.modalRow{margin-bottom:8px;}
.modalRow label{
  display:block;
  margin-bottom:2px;
  color:var(--muted);
}
.modalRow input,
.modalRow select,
.modalRow textarea{
  width:100%;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid rgba(148,163,184,0.6);
  background:#020617;
  color:#e5e7eb;
  font-size:13px;
}
.modalRow textarea{
  min-height:90px;
  resize:vertical;
}
.modalButtons{
  display:flex;
  justify-content:flex-end;
  gap:6px;
  margin-top:8px;
}
.modalButtons button{
  padding:6px 9px;
  border-radius:8px;
  border:none;
  font-size:12px;
  cursor:pointer;
}
.modalButtons .danger{
  background:linear-gradient(180deg,var(--bad),#b91c1c);
  color:#fee2e2;
}
.modalButtons .primary{
  background:linear-gradient(180deg,var(--good),#22c55e);
  color:#022c22;
}
.modalButtons .secondary{
  background:transparent;
  border:1px solid rgba(148,163,184,0.6);
  color:var(--muted);
}
.statsSectionTitle{
  font-weight:700;
  margin:8px 0 4px;
  font-size:13px;
}
.statsBarRow{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
.statsBarLabel{
  width:70px;
  font-size:11px;
  color:var(--muted);
}
.statsBarOuter{
  flex:1;
  height:8px;
  border-radius:999px;
  background:rgba(148,163,184,0.3);
  overflow:hidden;
}
.statsBarInner{
  height:100%;
  border-radius:999px;
  background:linear-gradient(90deg,#7ce3ff,#4ade80);
  width:0%;
}
.statsTiny{
  font-size:11px;
  color:var(--muted);
}

#app {
  padding-bottom: 160px !important;   /* clears the tiiny.site banner completely */
}

.addTaskBtn {
  position: relative;
  z-index: 100;   /* keeps the button above the ad even if it overlaps */
}

@media (max-height: 680px) {
  #app { padding-bottom: 190px !important; }
}

/* responsive */
@media(max-width:880px){
  .container{flex-direction:column}
}
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="brand">
      <div class="title">Chore Chart — Kid-Friendly</div>
      <div class="subtitle">Per-kid frames, fair chores, random cleanup, breaks & logging</div>
      <div class="daySelectorWrap">
        <div>Routine for:</div>
        <div class="dayButtons">
          <button class="dayBtn" data-day="0">Sun</button>
          <button class="dayBtn" data-day="1">Mon</button>
          <button class="dayBtn" data-day="2">Tue</button>
          <button class="dayBtn" data-day="3">Wed</button>
          <button class="dayBtn" data-day="4">Thu</button>
          <button class="dayBtn" data-day="5">Fri</button>
          <button class="dayBtn" data-day="6">Sat</button>
        </div>
      </div>
      <!-- HUGE CLOCK -->
      <div class="bigClock">
        <div id="dayLabel" class="bigDay"></div>
        <div id="clockLabel" class="bigTime"></div>
      </div>
    </div>
    <div class="controls">
      <button class="btn" id="resetBtn">Reset Day</button>
      <button class="btn secondary" id="statsBtn">Stats</button>
      <button class="btn secondary" id="helpBtn">How it works</button>
    </div>
  </div>

  <!-- FOCUS ON ONE KID BUTTONS -->
  <div class="focusSwitcher">
    <button class="focusKidBtn active" data-kid="both">Both Kids</button>
    <button class="focusKidBtn" data-kid="David">Only David</button>
    <button class="focusKidBtn" data-kid="Daxel">Only Daxel</button>
  </div>

  <div class="container" id="mainContainer">
    <!-- David column -->
    <div class="column" id="colDavid">
      <div class="kidHead">
        <div class="kidAvatar">D</div>
        <div>
          <div class="kidName">David <span class="kidXP" id="xpD">• 0 XP</span></div>
          <div class="kidXP">Streak: <span id="streakD">0</span> days</div>
        </div>
      </div>
      <div class="kidFrame">
        <div class="taskList" id="listD"></div>
      </div>
      <div class="footerStats" id="statsD"></div>
      <button class="addTaskBtn" data-kid="David">+ Add Task</button>
    </div>

    <!-- Daxel column -->
    <div class="column" id="colDaxel">
      <div class="kidHead">
        <div class="kidAvatar">X</div>
        <div>
          <div class="kidName">Daxel <span class="kidXP" id="xpX">• 0 XP</span></div>
          <div class="kidXP">Streak: <span id="streakX">0</span> days</div>
        </div>
      </div>
      <div class="kidFrame">
        <div class="taskList" id="listX"></div>
      </div>
      <div class="footerStats" id="statsX"></div>
      <button class="addTaskBtn" data-kid="Daxel">+ Add Task</button>
    </div>
  </div>

  <div style="margin-top:8px;color:var(--muted);font-size:12px">
    Tip: Click a task to switch that child's side into Focus Mode. When the timer finishes (or you hit Finish), progress updates, it logs what was done, and it can auto-jump to the next task.
  </div>

  <div id="overlays"></div>

  <!-- Focus overlay -->
  <div id="focusOverlay" class="focusOverlay">
    <div class="focusPanel" id="focusPanel"></div>
  </div>
</div>

<script>
/* =================== CONSTANTS & STATE =================== */
const SERVER_STATE_URL = 'https://chore-backend-production.up.railway.app/api/chore-state';
const STORAGE_KEY="CHART_V6";
const DAYS=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

/* default minutes */
const AUTO_TIME={
  "Brush Teeth":3,"Make Bed":3,"Exercise":25,"Devotion":25,"Feed Animals":5,
  "Breakfast":15,"Cleanup (Breakfast)":8,"Math":25,"English":25,"Science/Geography":25,
  "Lunch":20,"Cleanup (Lunch)":8,"Music":15,"Tasks":15,"Free Time":0,"Supper":25,
  "Cleanup (Supper)":8,"TBD":5,"Bed":5,"Upper Bathroom":15,"Lower Bathroom":15,
  "Vacuum":20,"Mop":20,"Bathtub":20,"Dishes":45,"Counters/Floors":20,"Trash":5
};

/* instructions as raw text */
const RAW_INSTRUCTIONS=`
Make Bed|Pull blankets up;Smooth blankets;Fix pillow;Tuck hanging sheets;Pick up stuffies;Check if it looks flat
Brush Teeth|Wet toothbrush;Add pea-size toothpaste;Brush top teeth;Brush bottom teeth;Brush gums;Brush tongue;Rinse and smile
Exercise|Pick 2–3 moves;Start timer;Do move #1;Switch to move #2;Add move #3 if time;Deep breaths;Walk slowly at end
Devotion|Find quiet spot;Get book or app;Read a short part;Pick one idea;Think how to use it today;Say short prayer or thought
Cleanup (Breakfast)|Take plate to sink;Take cup and silverware;Scrape food;Rinse if needed;Wipe your spot;Push in chair;Check floor
Cleanup (Lunch)|Carry dishes to sink;Throw away trash;Rinse plates;Wipe table;Push chair in;Check floor for food
Cleanup (Supper)|Clear plate and cup;Bring extra dishes;Scrape food;Rinse/load dishes;Wipe table;Wipe counter;Check under table
Math|Open to today's page;Read directions;Do problem #1;Check answer;Do next few;Tiny stretch;Mark where you stopped
English|Open book or sheet;Read instructions;Do first question;Check spelling;Do next 2–3;Read one aloud;Mark stopping spot
Science/Geography|Open book/video;Read or watch a little;Say one cool fact;Look at picture or map;Name something you see;Mark stopping spot
Upper Bathroom|Hang towels;Throw away trash;Clear sink;Wipe sink & faucet;Wipe counter;Quick mirror check;Check floor
Lower Bathroom|Pick up floor items;Put clothes in hamper;Throw away trash;Wipe sink;Wipe toilet seat & handle;Straighten towels;Check floor
Vacuum|Plug in vacuum;Start in open area;Go in straight lines;Do around couch;Do near table;Go over dirty spots twice;Put vacuum away
Mop|Sweep first;Get mop & cleaner;Wet small area;Mop that area;Move to next area;Scrub sticky spots;Rinse/put mop away
Bathtub|Remove toys;Rinse tub;Add cleaner to sponge;Scrub walls;Scrub floor;Rinse well;Put toys and cleaner away
Dishes|Bring all dishes;Scrape leftovers;Stack plates;Rinse plates/bowls;Rinse cups & silverware;Load dishwasher/sink;Quick sink wipe
Counters/Floors|Throw away trash;Put away food;Put items back;Spray counters;Wipe counters;Pick up big floor stuff;Sweep/vacuum paths
Trash|Check if full;Loosen bag edges;Tie bag;Take bag outside;Put new bag in;Pull edges over rim;Wash hands
`;

/* parse instructions */
const INSTRUCTIONS={};
RAW_INSTRUCTIONS.trim().split("\n").forEach(line=>{
  const [name,stepsStr]=line.split("|");
  if(!name||!stepsStr)return;
  INSTRUCTIONS[name.trim()]=stepsStr.split(";").map(s=>s.trim()).filter(Boolean);
});

/* helpers for dates */
function todayStr(){return new Date().toISOString().slice(0,10);}

/* =================== STATE & STORAGE =================== */
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
let selectedDayIndex = parseInt(localStorage.getItem('selectedDayIndex')) || new Date().getDay();
let timerState = {David:null, Daxel:null};

/* server sync */
async function loadFromServerAndMerge() {
  try {
    const res = await fetch(SERVER_STATE_URL);
    if (res.ok) {
      const serverState = await res.json();
      state = {...state, ...serverState};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
  } catch (e) {
    console.log("load from server failed", e);
  }
}

async function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  localStorage.setItem('selectedDayIndex', selectedDayIndex);
  try {
    await fetch(SERVER_STATE_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(state)
    });
  } catch (e) {
    console.log("server save failed", e);
  }
}

/* uid generator */
function uid() {
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}

/* =================== ROLLOVER LOGIC =================== */
function handleDayRollover() {
  const lastDate = state.lastDate || todayStr();
  const today = todayStr();
  if (lastDate !== today) {
    // Roll over undone tasks
    const yesterdayIndex = new Date(lastDate).getDay();
    const todayIndex = new Date(today).getDay();
    for (let d = yesterdayIndex; d !== todayIndex; d = (d + 1) % 7) {
      const tasks = state.tasks[d] || [];
      const undone = tasks.filter(t => !t.done);
      if (undone.length > 0) {
        const tomorrowTasks = state.tasks[todayIndex] || [];
        undone.forEach(t => {
          if (t.kid === "David") t.kid = "Daxel";
          else if (t.kid === "Daxel") t.kid = "David";
          tomorrowTasks.push(t);
        });
        state.tasks[todayIndex] = tomorrowTasks;
        state.tasks[d] = tasks.filter(t => t.done);
      }
    }
    state.lastDate = today;
    state.xp = {David:0, Daxel:0};
    state.streak = {David:0, Daxel:0};
    save();
  }
}

/* =================== HELPERS =================== */
function escapeHtml(s){
  return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function tasksToday(){return state.tasks[selectedDayIndex]||[];}
function tasksForKidToday(kid){
  return tasksToday().filter(t=>t.kid===kid||t.kid==="Both");
}
function findTask(uid){
  return tasksToday().find(t=>t.uid===uid)||null;
}

function ensureDoneBy(t){
  if(!t.doneBy){
    t.doneBy={David:!!t.done,Daxel:!!t.done};
  }
  return t.doneBy;
}
function isTaskDoneForKid(t,kid){
  const db=ensureDoneBy(t);
  return !!db[kid];
}
function markTaskDoneForKid(t,kid){
  const db=ensureDoneBy(t);
  if(!db[kid]){
    db[kid] = true;
    save();
  }
}
function resetTaskDone(t){
  t.done = false;
  t.doneBy = {David: false, Daxel: false};
}

function getTaskMinutes(t) {
  return t.minutes !== undefined ? t.minutes : AUTO_TIME[t.text] || null;
}
function setTaskMinutesForName(name, minutes) {
  if (minutes === null) {
    delete AUTO_TIME[name];
  } else {
    AUTO_TIME[name] = minutes;
  }
}

/* =================== RENDERING =================== */
function renderClock() {
  const now = new Date();
  document.getElementById("dayLabel").textContent = DAYS[now.getDay()];
  document.getElementById("clockLabel").textContent = now.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
}
setInterval(renderClock, 1000);
renderClock();

function renderTask(t) {
  const doneForDavid = isTaskDoneForKid(t, "David");
  const doneForDaxel = isTaskDoneForKid(t, "Daxel");
  const isDone = t.kid === "Both" ? doneForDavid && doneForDaxel : doneForDavid || doneForDaxel;
  const className = isDone ? "card cardDone" : "card cardTodo";
  const star = "⭐";
  const minutes = getTaskMinutes(t);
  const meta = minutes ? `${minutes} min` : "";
  return `<div class="${className}" data-uid="${t.uid}">
    <div class="starIcon">${star}</div>
    <div class="cardTitle">
      <strong>${escapeHtml(t.text)}</strong>
      <div class="cardMeta">${meta}</div>
    </div>
    <button class="editBtn">Edit</button>
    <button class="moveBtn">Move</button>
  </div>`;
}

function renderList(kid) {
  const listEl = document.getElementById(`list${kid.charAt(0)}`);
  const tasks = tasksForKidToday(kid);
  listEl.innerHTML = tasks.map(renderTask).join('');
  tasks.forEach(t => {
    const el = listEl.querySelector(`[data-uid="${t.uid}"]`);
    if (el) {
      el.onclick = () => openFocusForTask(t, kid);
      el.querySelector(".editBtn").onclick = (e) => { e.stopPropagation(); openEdit(t.uid); };
      el.querySelector(".moveBtn").onclick = (e) => { e.stopPropagation(); /* move logic */ };
    }
  });
}

function renderStats() {
  const kids = ["David", "Daxel"];
  kids.forEach(kid => {
    const tasks = tasksForKidToday(kid);
    const done = tasks.filter(t => isTaskDoneForKid(t, kid)).length;
    const total = tasks.length;
    const xpEl = document.getElementById(`xp${kid.charAt(0)}`);
    const streakEl = document.getElementById(`streak${kid.charAt(0)}`);
    xpEl.textContent = `• ${state.xp?.[kid] || 0} XP`;
    streakEl.textContent = state.streak?.[kid] || 0;
    // Progress bar
    const progress = total > 0 ? (done / total * 100) : 0;
    const statsEl = document.getElementById(`stats${kid.charAt(0)}`);
    statsEl.innerHTML = `
      <div class="progressOuter"><div class="progressInner" style="width: ${progress}%"></div></div>
      <div class="statsTiny">${done}/${total} tasks done</div>
    `;
  });
}

function renderAll() {
  renderList("David");
  renderList("Daxel");
  renderStats();
}

/* =================== FOCUS MODE =================== */
function openFocusForTask(task, kid) {
  const minutes = getTaskMinutes(task);
  const baseSec = minutes ? minutes * 60 : 0;
  timerState[kid] = {
    kid, taskUid: task.uid, taskText: task.text,
    mode: "focus",
    totalSec: baseSec, remainingSec: baseSec,
    running: false, interval: null,
    domTimerEl: null, domStartBtn: null
  };
  renderFocusOverlay(kid);
}

function renderFocusOverlay(kid) {
  const ts = timerState[kid];
  if (!ts) return;
  const panel = document.getElementById("focusPanel");
  panel.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <button onclick="closeFocusOverlay()" style="padding:8px 16px;border-radius:12px;background:rgba(255,255,255,0.1);border:none;color:var(--muted);">Back</button>
    </div>
    <h1 class="focusTitle">${ts.taskText}</h1>
    <div class="timerShell">
      <div class="timerBig" id="timerDisplay">${formatTime(ts.remainingSec)}</div>
    </div>
    <div class="fieldRow">
      <label>Add minutes:</label>
      <input type="number" min="1" max="60" value="5" onchange="addMinutes('${kid}', parseInt(this.value))">
    </div>
    <button class="focusBtn" id="startPauseBtn" onclick="toggleStartPause('${kid}')">Start</button>
    <button class="focusBtn" onclick="finishSession('${kid}')">Finish</button>
    <button class="focusBtn" onclick="cancelSession('${kid}')">Cancel</button>
    <div class="focusInstr">
      <h3>Steps:</h3>
      <ol class="focusSteps">
        ${(state.customInstructions?.[ts.taskText] || INSTRUCTIONS[ts.taskText] || ["No steps defined"]).map(step => `<li class="focusStep">${step}</li>`).join('')}
      </ol>
    </div>
  `;
  document.getElementById("focusOverlay").style.display = "flex";
  const timerEl = document.getElementById("timerDisplay");
  const btnStart = document.getElementById("startPauseBtn");
  ts.domTimerEl = timerEl;
  ts.domStartBtn = btnStart;
  updateTimerDisplay(kid);
}

function closeFocusOverlay() {
  document.getElementById("focusOverlay").style.display = "none";
  Object.values(timerState).forEach(ts => {
    if (ts && ts.interval) clearInterval(ts.interval);
  });
}

function updateTimerDisplay(kid){
  const ts=timerState[kid];
  if(!ts||!ts.domTimerEl)return;
  const el=ts.domTimerEl;
  if(ts.remainingSec>=0){
    el.textContent=formatTime(ts.remainingSec);
    el.classList.remove("overdue");
  }else{
    const over=-ts.remainingSec;
    el.textContent=`0:00 (+${formatTime(over)})`;
    el.classList.add("overdue");
  }
}
function formatTime(sec){
  const s=Math.max(sec,0);
  const m=Math.floor(s/60),r=s%60;
  return `${m}:${String(r).padStart(2,"0")}`;
}
function toggleStartPause(kid){
  const ts=timerState[kid];if(!ts)return;
  if(ts.running){
    clearInterval(ts.interval);ts.interval=null;ts.running=false;
    if(ts.domStartBtn)ts.domStartBtn.textContent="Start";
  }else{
    ts.running=true;
    if(ts.domStartBtn)ts.domStartBtn.textContent="Pause";
    ts.interval=setInterval(()=>tickTimer(kid),1000);
  }
}
function tickTimer(kid){
  const ts=timerState[kid];if(!ts)return;
  ts.remainingSec--;
  updateTimerDisplay(kid);
}
function addMinutes(kid,mins){
  const ts=timerState[kid];if(!ts)return;
  const add=mins*60;ts.totalSec+=add;ts.remainingSec+=add;
  updateTimerDisplay(kid);
}

function finishSession(kid){
  const ts=timerState[kid];if(!ts)return;
  if(ts.interval)clearInterval(ts.interval);
  ts.running=false;
  const task=findTask(ts.taskUid);
  if(task)markTaskDoneForKid(task,kid);
  state.xp[kid]=(state.xp[kid]||0)+5;
  state.streak[kid]=(state.streak[kid]||0)+1;
  save();
  closeFocusOverlay();
  renderAll();
  renderStats();
  timerState[kid]=null;
}

/* =================== FOCUS MODE JS =================== */
// ONE-KID FOCUS MODE – FINAL WORKING
document.querySelectorAll(".focusKidBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".focusKidBtn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const mode = btn.dataset.kid;
    document.querySelectorAll(".column").forEach(col => {
      col.style.display = (mode === "both" || col.id === "col" + mode) ? "flex" : "none";
    });
  });
});

/* =================== BUTTONS & INIT =================== */
document.getElementById("resetBtn").onclick=()=>{
  if(confirm("Reset daily progress?")){
    Object.keys(state.tasks||{}).forEach(dayKey=>{
      const arr=state.tasks[dayKey]||[];
      const kept=arr.filter(t=>t.repeatWeekly!==false);
      kept.forEach(resetTaskDone);
      state.tasks[dayKey]=kept;
    });
    state.xp={David:0,Daxel:0};
    state.streak={David:0,Daxel:0};
    save();
    renderAll();
  }
};

document.querySelectorAll(".dayBtn").forEach(btn=>{
  const idx=parseInt(btn.dataset.day,10);
  if(idx===selectedDayIndex)btn.classList.add("active");
  btn.onclick=()=>{
    selectedDayIndex=idx;
    document.querySelectorAll(".dayBtn").forEach(b=>b.classList.toggle("active",b.dataset.day==idx));
    renderAll();
    save();
  };
});

document.querySelectorAll(".addTaskBtn").forEach(btn=>{
  btn.onclick=()=>openNewTask(btn.dataset.kid||"Both");
});

/* INIT */
document.addEventListener("DOMContentLoaded", async () => {
  await loadFromServerAndMerge();
  handleDayRollover();
  renderAll();
});
</script>
</body>
</html>
